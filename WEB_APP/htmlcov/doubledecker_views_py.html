<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for doubledecker\views.py: 98%</title>
    <link rel="icon" sizes="32x32" href="favicon_32.png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">
<div id="header">
    <div class="content">
        <h1>Coverage for <b>doubledecker\views.py</b> :
            <span class="pc_cov">98%</span>
        </h1>
        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />
        <h2 class="stats">
            218 statements &nbsp;
            <button type="button" class="run shortkey_r button_toggle_run" title="Toggle lines run">214 run</button>
            <button type="button" class="mis show_mis shortkey_m button_toggle_mis" title="Toggle lines missing">4 missing</button>
            <button type="button" class="exc show_exc shortkey_x button_toggle_exc" title="Toggle lines excluded">0 excluded</button>
        </h2>
    </div>
</div>
<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>
<div id="source">
    <p id="t1" class="run"><span class="n"><a href="#t1">1</a></span><span class="t"><span class="key">from</span> <span class="nam">datetime</span> <span class="key">import</span> <span class="nam">datetime</span><span class="op">,</span> <span class="nam">timedelta</span>&nbsp;</span><span class="r"></span></p>
    <p id="t2" class="run"><span class="n"><a href="#t2">2</a></span><span class="t"><span class="key">import</span> <span class="nam">os</span>&nbsp;</span><span class="r"></span></p>
    <p id="t3" class="run"><span class="n"><a href="#t3">3</a></span><span class="t"><span class="key">import</span> <span class="nam">math</span>&nbsp;</span><span class="r"></span></p>
    <p id="t4" class="run"><span class="n"><a href="#t4">4</a></span><span class="t"><span class="key">from</span> <span class="nam">geopy</span><span class="op">.</span><span class="nam">distance</span> <span class="key">import</span> <span class="nam">distance</span> <span class="key">as</span> <span class="nam">d</span>&nbsp;</span><span class="r"></span></p>
    <p id="t5" class="run"><span class="n"><a href="#t5">5</a></span><span class="t"><span class="key">from</span> <span class="nam">django</span><span class="op">.</span><span class="nam">shortcuts</span> <span class="key">import</span> <span class="nam">render</span>&nbsp;</span><span class="r"></span></p>
    <p id="t6" class="pln"><span class="n"><a href="#t6">6</a></span><span class="t"><span class="com"># origionated from https://docs.djangoproject.com/en/3.2/intro/tutorial01/</span>&nbsp;</span><span class="r"></span></p>
    <p id="t7" class="run"><span class="n"><a href="#t7">7</a></span><span class="t"><span class="key">from</span> <span class="nam">django</span><span class="op">.</span><span class="nam">http</span> <span class="key">import</span> <span class="nam">HttpResponse</span>&nbsp;</span><span class="r"></span></p>
    <p id="t8" class="pln"><span class="n"><a href="#t8">8</a></span><span class="t"><span class="com"># Create your views here.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t9" class="run"><span class="n"><a href="#t9">9</a></span><span class="t"><span class="key">from</span> <span class="nam">django</span><span class="op">.</span><span class="nam">http</span> <span class="key">import</span> <span class="nam">JsonResponse</span>&nbsp;</span><span class="r"></span></p>
    <p id="t10" class="run"><span class="n"><a href="#t10">10</a></span><span class="t"><span class="key">from</span> <span class="nam">joblib</span> <span class="key">import</span> <span class="nam">load</span>&nbsp;</span><span class="r"></span></p>
    <p id="t11" class="run"><span class="n"><a href="#t11">11</a></span><span class="t"><span class="key">import</span> <span class="nam">os</span>&nbsp;</span><span class="r"></span></p>
    <p id="t12" class="run"><span class="n"><a href="#t12">12</a></span><span class="t"><span class="key">from</span> <span class="op">.</span><span class="nam">models</span> <span class="key">import</span> <span class="nam">Weather</span>&nbsp;</span><span class="r"></span></p>
    <p id="t13" class="run"><span class="n"><a href="#t13">13</a></span><span class="t"><span class="key">from</span> <span class="nam">math</span> <span class="key">import</span> <span class="nam">ceil</span><span class="op">,</span> <span class="nam">floor</span>&nbsp;</span><span class="r"></span></p>
    <p id="t14" class="run"><span class="n"><a href="#t14">14</a></span><span class="t"><span class="key">import</span> <span class="nam">pickle</span>&nbsp;</span><span class="r"></span></p>
    <p id="t15" class="run"><span class="n"><a href="#t15">15</a></span><span class="t"><span class="key">import</span> <span class="nam">pandas</span> <span class="key">as</span> <span class="nam">pd</span>&nbsp;</span><span class="r"></span></p>
    <p id="t16" class="run"><span class="n"><a href="#t16">16</a></span><span class="t"><span class="key">import</span> <span class="nam">re</span>&nbsp;</span><span class="r"></span></p>
    <p id="t17" class="run"><span class="n"><a href="#t17">17</a></span><span class="t"><span class="key">import</span> <span class="nam">json</span>&nbsp;</span><span class="r"></span></p>
    <p id="t18" class="pln"><span class="n"><a href="#t18">18</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t19" class="run"><span class="n"><a href="#t19">19</a></span><span class="t"><span class="nam">stop_times</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">read_csv</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/RAW_DATA/gtfs/stop_times.txt"</span><span class="op">,</span> <span class="nam">delimiter</span><span class="op">=</span><span class="str">","</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t20" class="run"><span class="n"><a href="#t20">20</a></span><span class="t"><span class="nam">stops</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">read_csv</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/RAW_DATA/gtfs/stops.txt"</span><span class="op">,</span> <span class="nam">delimiter</span><span class="op">=</span><span class="str">","</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t21" class="run"><span class="n"><a href="#t21">21</a></span><span class="t"><span class="nam">routes</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">read_csv</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/RAW_DATA/gtfs/routes.txt"</span><span class="op">,</span> <span class="nam">delimiter</span><span class="op">=</span><span class="str">","</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t22" class="run"><span class="n"><a href="#t22">22</a></span><span class="t"><span class="nam">trips</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">read_csv</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/RAW_DATA/gtfs/trips.txt"</span><span class="op">,</span> <span class="nam">delimiter</span><span class="op">=</span><span class="str">","</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t23" class="run"><span class="n"><a href="#t23">23</a></span><span class="t"><span class="nam">calendar</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">read_csv</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/RAW_DATA/gtfs/calendar.txt"</span><span class="op">,</span> <span class="nam">delimiter</span><span class="op">=</span><span class="str">","</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t24" class="run"><span class="n"><a href="#t24">24</a></span><span class="t"><span class="nam">stop_times</span><span class="op">[</span><span class="str">"arrival_time"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">to_timedelta</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"arrival_time"</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t25" class="pln"><span class="n"><a href="#t25">25</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t26" class="pln"><span class="n"><a href="#t26">26</a></span><span class="t"><span class="com"># https://stackoverflow.com/questions/11218477/how-can-i-use-pickle-to-save-a-dict</span>&nbsp;</span><span class="r"></span></p>
    <p id="t27" class="run"><span class="n"><a href="#t27">27</a></span><span class="t"><span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="str">'../DATA_ANALYTICS/journeytimes.pickle'</span><span class="op">,</span> <span class="str">'rb'</span><span class="op">)</span> <span class="key">as</span> <span class="nam">handle</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t28" class="run"><span class="n"><a href="#t28">28</a></span><span class="t">    <span class="nam">journeytimes</span> <span class="op">=</span> <span class="nam">pickle</span><span class="op">.</span><span class="nam">load</span><span class="op">(</span><span class="nam">handle</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t29" class="pln"><span class="n"><a href="#t29">29</a></span><span class="t"><span class="com"># https://stackoverflow.com/questions/11218477/how-can-i-use-pickle-to-save-a-dict</span>&nbsp;</span><span class="r"></span></p>
    <p id="t30" class="run"><span class="n"><a href="#t30">30</a></span><span class="t"><span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="str">'../DATA_ANALYTICS/distances.pickle'</span><span class="op">,</span> <span class="str">'rb'</span><span class="op">)</span> <span class="key">as</span> <span class="nam">handle</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t31" class="run"><span class="n"><a href="#t31">31</a></span><span class="t">    <span class="nam">distances</span> <span class="op">=</span> <span class="nam">pickle</span><span class="op">.</span><span class="nam">load</span><span class="op">(</span><span class="nam">handle</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t32" class="pln"><span class="n"><a href="#t32">32</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t33" class="run"><span class="n"><a href="#t33">33</a></span><span class="t"><span class="nam">janmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/jangbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t34" class="run"><span class="n"><a href="#t34">34</a></span><span class="t"><span class="nam">febmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/febgbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t35" class="run"><span class="n"><a href="#t35">35</a></span><span class="t"><span class="nam">marchmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/marchgbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t36" class="run"><span class="n"><a href="#t36">36</a></span><span class="t"><span class="nam">aprilmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/aprilgbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t37" class="run"><span class="n"><a href="#t37">37</a></span><span class="t"><span class="nam">maymodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/maygbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t38" class="run"><span class="n"><a href="#t38">38</a></span><span class="t"><span class="nam">junemodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/junegbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t39" class="run"><span class="n"><a href="#t39">39</a></span><span class="t"><span class="nam">julymodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/julygbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t40" class="run"><span class="n"><a href="#t40">40</a></span><span class="t"><span class="nam">augmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/auggbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t41" class="run"><span class="n"><a href="#t41">41</a></span><span class="t"><span class="nam">sepmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/sepgbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t42" class="run"><span class="n"><a href="#t42">42</a></span><span class="t"><span class="nam">octmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/octgbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t43" class="run"><span class="n"><a href="#t43">43</a></span><span class="t"><span class="nam">novmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/novgbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t44" class="run"><span class="n"><a href="#t44">44</a></span><span class="t"><span class="nam">decmodel</span> <span class="op">=</span> <span class="nam">load</span><span class="op">(</span><span class="str">"../DATA_ANALYTICS/MODELS/decgbr.joblib"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t45" class="pln"><span class="n"><a href="#t45">45</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t46" class="pln"><span class="n"><a href="#t46">46</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t47" class="run"><span class="n"><a href="#t47">47</a></span><span class="t"><span class="key">class</span> <span class="nam">RouteNotAvailable</span><span class="op">(</span><span class="nam">Exception</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t48" class="pln"><span class="n"><a href="#t48">48</a></span><span class="t">    <span class="str">"""Raised when there was no route available from the origin stop to the destination stop"""</span>  <span class="com"># gtfs appraently not complete</span>&nbsp;</span><span class="r"></span></p>
    <p id="t49" class="run"><span class="n"><a href="#t49">49</a></span><span class="t">    <span class="key">pass</span>&nbsp;</span><span class="r"></span></p>
    <p id="t50" class="pln"><span class="n"><a href="#t50">50</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t51" class="pln"><span class="n"><a href="#t51">51</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t52" class="run"><span class="n"><a href="#t52">52</a></span><span class="t"><span class="key">class</span> <span class="nam">PartialRouteNotAvailable</span><span class="op">(</span><span class="nam">Exception</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t53" class="pln"><span class="n"><a href="#t53">53</a></span><span class="t">    <span class="str">"""Raised when there was no route available from one stop to another on the journey"""</span>  <span class="com"># gtfs appraently not complete</span>&nbsp;</span><span class="r"></span></p>
    <p id="t54" class="run"><span class="n"><a href="#t54">54</a></span><span class="t">    <span class="key">pass</span>&nbsp;</span><span class="r"></span></p>
    <p id="t55" class="pln"><span class="n"><a href="#t55">55</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t56" class="pln"><span class="n"><a href="#t56">56</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t57" class="run"><span class="n"><a href="#t57">57</a></span><span class="t"><span class="key">def</span> <span class="nam">main</span><span class="op">(</span><span class="nam">request</span><span class="op">)</span><span class="op">:</span>  <span class="com"># origionated from  https://docs.djangoproject.com/en/3.2/intro/tutorial01/</span>&nbsp;</span><span class="r"></span></p>
    <p id="t58" class="run"><span class="n"><a href="#t58">58</a></span><span class="t">    <span class="key">return</span> <span class="nam">render</span><span class="op">(</span><span class="nam">request</span><span class="op">,</span> <span class="str">'doubledecker/index.html'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t59" class="pln"><span class="n"><a href="#t59">59</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t60" class="pln"><span class="n"><a href="#t60">60</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t61" class="pln"><span class="n"><a href="#t61">61</a></span><span class="t"><span class="com"># origionated from  https://docs.djangoproject.com/en/3.2/intro/tutorial01/</span>&nbsp;</span><span class="r"></span></p>
    <p id="t62" class="run"><span class="n"><a href="#t62">62</a></span><span class="t"><span class="key">def</span> <span class="nam">explore_view</span><span class="op">(</span><span class="nam">request</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t63" class="run"><span class="n"><a href="#t63">63</a></span><span class="t">    <span class="key">return</span> <span class="nam">render</span><span class="op">(</span><span class="nam">request</span><span class="op">,</span> <span class="str">'doubledecker/explore.html'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t64" class="pln"><span class="n"><a href="#t64">64</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t65" class="pln"><span class="n"><a href="#t65">65</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t66" class="run"><span class="n"><a href="#t66">66</a></span><span class="t"><span class="key">def</span> <span class="nam">tourism_views</span><span class="op">(</span><span class="nam">request</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t67" class="run"><span class="n"><a href="#t67">67</a></span><span class="t">    <span class="key">return</span> <span class="nam">render</span><span class="op">(</span><span class="nam">request</span><span class="op">,</span> <span class="str">'doubledecker/tourism.html'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t68" class="pln"><span class="n"><a href="#t68">68</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t69" class="pln"><span class="n"><a href="#t69">69</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t70" class="pln"><span class="n"><a href="#t70">70</a></span><span class="t"><span class="com"># from  https://www.youtube.com/watch?v=_3xj9B0qqps&amp;t=1739s and corresponding github https://github.com/veryacademy/YT-Django-Iris-App-3xj9B0qqps/blob/master/templates/predict.html</span>&nbsp;</span><span class="r"></span></p>
    <p id="t71" class="run"><span class="n"><a href="#t71">71</a></span><span class="t"><span class="key">def</span> <span class="nam">model</span><span class="op">(</span><span class="nam">request</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t72" class="run"><span class="n"><a href="#t72">72</a></span><span class="t">    <span class="key">def</span> <span class="nam">route_journey_time</span><span class="op">(</span><span class="nam">DayOfService</span><span class="op">,</span> <span class="nam">day</span><span class="op">,</span> <span class="nam">LineId</span><span class="op">,</span> <span class="nam">olat</span><span class="op">,</span> <span class="nam">olng</span><span class="op">,</span> <span class="nam">dlat</span><span class="op">,</span> <span class="nam">dlng</span><span class="op">,</span> <span class="nam">departure</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t73" class="run"><span class="n"><a href="#t73">73</a></span><span class="t">        <span class="nam">month</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">fromtimestamp</span><span class="op">(</span><span class="nam">DayOfService</span><span class="op">)</span><span class="op">.</span><span class="nam">month</span>&nbsp;</span><span class="r"></span></p>
    <p id="t74" class="run"><span class="n"><a href="#t74">74</a></span><span class="t">        <span class="key">if</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t75" class="run"><span class="n"><a href="#t75">75</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">janmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t76" class="run"><span class="n"><a href="#t76">76</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">2</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t77" class="run"><span class="n"><a href="#t77">77</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">febmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t78" class="run"><span class="n"><a href="#t78">78</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">3</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t79" class="run"><span class="n"><a href="#t79">79</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">marchmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t80" class="run"><span class="n"><a href="#t80">80</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">4</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t81" class="run"><span class="n"><a href="#t81">81</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">aprilmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t82" class="run"><span class="n"><a href="#t82">82</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">5</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t83" class="run"><span class="n"><a href="#t83">83</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">maymodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t84" class="run"><span class="n"><a href="#t84">84</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">6</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t85" class="run"><span class="n"><a href="#t85">85</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">junemodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t86" class="run"><span class="n"><a href="#t86">86</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">7</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t87" class="run"><span class="n"><a href="#t87">87</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">julymodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t88" class="run"><span class="n"><a href="#t88">88</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">8</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t89" class="run"><span class="n"><a href="#t89">89</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">augmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t90" class="run"><span class="n"><a href="#t90">90</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">9</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t91" class="run"><span class="n"><a href="#t91">91</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">sepmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t92" class="run"><span class="n"><a href="#t92">92</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">10</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t93" class="run"><span class="n"><a href="#t93">93</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">octmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t94" class="run"><span class="n"><a href="#t94">94</a></span><span class="t">        <span class="key">elif</span> <span class="nam">month</span> <span class="op">==</span> <span class="num">11</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t95" class="run"><span class="n"><a href="#t95">95</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">novmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t96" class="pln"><span class="n"><a href="#t96">96</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t97" class="run"><span class="n"><a href="#t97">97</a></span><span class="t">            <span class="nam">loadedmodel</span> <span class="op">=</span> <span class="nam">decmodel</span>&nbsp;</span><span class="r"></span></p>
    <p id="t98" class="pln"><span class="n"><a href="#t98">98</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t99" class="run"><span class="n"><a href="#t99">99</a></span><span class="t">        <span class="nam">days</span> <span class="op">=</span> <span class="op">{</span><span class="str">"Monday"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"Tuesday"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"Wednesday"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"Thursday"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"Friday"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"Saturday"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"Sunday"</span><span class="op">:</span> <span class="num">0</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t100" class="run"><span class="n"><a href="#t100">100</a></span><span class="t">        <span class="nam">days</span><span class="op">[</span><span class="nam">day</span><span class="op">]</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t101" class="run"><span class="n"><a href="#t101">101</a></span><span class="t">        <span class="nam">current</span> <span class="op">=</span> <span class="nam">Weather</span><span class="op">.</span><span class="nam">objects</span><span class="op">.</span><span class="nam">order_by</span><span class="op">(</span><span class="str">'current'</span><span class="op">)</span><span class="op">.</span><span class="nam">first</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t102" class="run"><span class="n"><a href="#t102">102</a></span><span class="t">        <span class="nam">temp</span> <span class="op">=</span> <span class="op">(</span><span class="nam">getattr</span><span class="op">(</span><span class="nam">current</span><span class="op">,</span> <span class="str">'temperature'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t103" class="run"><span class="n"><a href="#t103">103</a></span><span class="t">        <span class="nam">rain</span> <span class="op">=</span> <span class="nam">getattr</span><span class="op">(</span><span class="nam">current</span><span class="op">,</span> <span class="str">'rain_1h'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t104" class="run"><span class="n"><a href="#t104">104</a></span><span class="t">        <span class="nam">msl</span> <span class="op">=</span> <span class="nam">getattr</span><span class="op">(</span><span class="nam">current</span><span class="op">,</span> <span class="str">'pressure'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t105" class="run"><span class="n"><a href="#t105">105</a></span><span class="t">        <span class="nam">rhum</span> <span class="op">=</span> <span class="nam">getattr</span><span class="op">(</span><span class="nam">current</span><span class="op">,</span> <span class="str">'humidity'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t106" class="run"><span class="n"><a href="#t106">106</a></span><span class="t">        <span class="key">try</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t107" class="run"><span class="n"><a href="#t107">107</a></span><span class="t">            <span class="nam">routes</span> <span class="op">=</span> <span class="nam">get_route</span><span class="op">(</span><span class="nam">departure</span><span class="op">,</span> <span class="nam">olat</span><span class="op">,</span> <span class="nam">olng</span><span class="op">,</span> <span class="nam">dlat</span><span class="op">,</span> <span class="nam">dlng</span><span class="op">,</span> <span class="nam">day</span><span class="op">,</span> <span class="nam">LineId</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t108" class="run"><span class="n"><a href="#t108">108</a></span><span class="t">        <span class="key">except</span> <span class="nam">IndexError</span> <span class="key">as</span> <span class="nam">e</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t109" class="run"><span class="n"><a href="#t109">109</a></span><span class="t">            <span class="key">raise</span> <span class="nam">RouteNotAvailable</span>&nbsp;</span><span class="r"></span></p>
    <p id="t110" class="pln"><span class="n"><a href="#t110">110</a></span><span class="t">        <span class="com"># assume june july and august all schools off and we are using monthly data so do not need to give model that detail for those months as will be constant col</span>&nbsp;</span><span class="r"></span></p>
    <p id="t111" class="run"><span class="n"><a href="#t111">111</a></span><span class="t">        <span class="nam">holidays</span> <span class="op">=</span> <span class="op">[</span><span class="str">"2021-01-06"</span><span class="op">,</span> <span class="str">"2021-02-17"</span><span class="op">,</span> <span class="str">"2021-02-18"</span><span class="op">,</span> <span class="str">"2021-02-19"</span><span class="op">,</span> <span class="str">"2021-02-20"</span><span class="op">,</span> <span class="str">"2021-02-21"</span><span class="op">,</span> <span class="str">"2021-04-03"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t112" class="pln"><span class="n"><a href="#t112">112</a></span><span class="t">                    <span class="str">"2021-04-04"</span><span class="op">,</span> <span class="str">"2021-04-05"</span><span class="op">,</span> <span class="str">"2021-04-06"</span><span class="op">,</span> <span class="str">"2021-04-07"</span><span class="op">,</span> <span class="str">"2021-04-08"</span><span class="op">,</span> <span class="str">"2021-04-09"</span><span class="op">,</span> <span class="str">"2021-04-10"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t113" class="pln"><span class="n"><a href="#t113">113</a></span><span class="t">                    <span class="str">"2021-04-11"</span><span class="op">,</span> <span class="str">"2021-04-12"</span><span class="op">,</span> <span class="str">"2021-04-13"</span><span class="op">,</span> <span class="str">"2021-04-14"</span><span class="op">,</span> <span class="str">"2021-04-15"</span><span class="op">,</span> <span class="str">"2021-04-16"</span><span class="op">,</span> <span class="str">"2021-04-17"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t114" class="pln"><span class="n"><a href="#t114">114</a></span><span class="t">                    <span class="str">"2021-04-18"</span><span class="op">,</span> <span class="str">"2021-04-19"</span><span class="op">,</span> <span class="str">"2020-06-07"</span><span class="op">,</span> <span class="str">"2021-09-25"</span><span class="op">,</span> <span class="str">"2021-09-26"</span><span class="op">,</span> <span class="str">"2021-09-27"</span><span class="op">,</span> <span class="str">"2021-09-28"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t115" class="pln"><span class="n"><a href="#t115">115</a></span><span class="t">                    <span class="str">"2021-09-29"</span><span class="op">,</span> <span class="str">"2021-10-31"</span><span class="op">,</span> <span class="str">"2021-11-07"</span><span class="op">,</span> <span class="str">"2021-11-08"</span><span class="op">,</span> <span class="str">"2021-11-09"</span><span class="op">,</span> <span class="str">"2021-11-10"</span><span class="op">,</span> <span class="str">"2021-11-11"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t116" class="pln"><span class="n"><a href="#t116">116</a></span><span class="t">                    <span class="str">"2021-11-12"</span><span class="op">,</span> <span class="str">"2021-11-13"</span><span class="op">,</span> <span class="str">"2021-11-14"</span><span class="op">,</span> <span class="str">"2021-12-22"</span><span class="op">,</span> <span class="str">"2021-12-23"</span><span class="op">,</span> <span class="str">"2021-12-24"</span><span class="op">,</span> <span class="str">"2021-12-25"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t117" class="pln"><span class="n"><a href="#t117">117</a></span><span class="t">                    <span class="str">"2021-12-26"</span><span class="op">,</span> <span class="str">"2021-12-27"</span><span class="op">,</span> <span class="str">"2021-12-28"</span><span class="op">,</span> <span class="str">"2021-12-29"</span><span class="op">,</span> <span class="str">"2021-12-30"</span><span class="op">,</span> <span class="str">"2021-12-31"</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t118" class="run"><span class="n"><a href="#t118">118</a></span><span class="t">        <span class="nam">holiday</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t119" class="run"><span class="n"><a href="#t119">119</a></span><span class="t">        <span class="key">if</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">fromtimestamp</span><span class="op">(</span><span class="nam">DayOfService</span><span class="op">)</span><span class="op">.</span><span class="nam">strftime</span><span class="op">(</span><span class="str">"%Y-%m-%d"</span><span class="op">)</span> <span class="key">in</span> <span class="nam">holidays</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t120" class="run"><span class="n"><a href="#t120">120</a></span><span class="t">            <span class="nam">holiday</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t121" class="pln"><span class="n"><a href="#t121">121</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t122" class="run"><span class="n"><a href="#t122">122</a></span><span class="t">        <span class="nam">total_time</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p id="t123" class="run"><span class="n"><a href="#t123">123</a></span><span class="t">        <span class="nam">df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">DataFrame</span><span class="op">(</span><span class="nam">columns</span><span class="op">=</span><span class="op">[</span><span class="str">'Monday'</span><span class="op">,</span> <span class="str">'Tuesday'</span><span class="op">,</span> <span class="str">'Wednesday'</span><span class="op">,</span> <span class="str">'Thursday'</span><span class="op">,</span> <span class="str">'Friday'</span><span class="op">,</span> <span class="str">'Saturday'</span><span class="op">,</span> <span class="str">'Sunday'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t124" class="pln"><span class="n"><a href="#t124">124</a></span><span class="t">                                   <span class="str">'timetabledtimes'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t125" class="pln"><span class="n"><a href="#t125">125</a></span><span class="t">                                   <span class="str">'distance'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t126" class="pln"><span class="n"><a href="#t126">126</a></span><span class="t">                                   <span class="str">'rain'</span><span class="op">,</span> <span class="str">'temp'</span><span class="op">,</span> <span class="str">'rhum'</span><span class="op">,</span> <span class="str">'msl'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t127" class="pln"><span class="n"><a href="#t127">127</a></span><span class="t">                                   <span class="str">'holiday'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t128" class="pln"><span class="n"><a href="#t128">128</a></span><span class="t">                                   <span class="str">'hour_0'</span><span class="op">,</span> <span class="str">'hour_1'</span><span class="op">,</span> <span class="str">'hour_5'</span><span class="op">,</span> <span class="str">'hour_6'</span><span class="op">,</span> <span class="str">'hour_7'</span><span class="op">,</span> <span class="str">'hour_8'</span><span class="op">,</span> <span class="str">'hour_9'</span><span class="op">,</span> <span class="str">'hour_10'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t129" class="pln"><span class="n"><a href="#t129">129</a></span><span class="t">                                   <span class="str">'hour_11'</span><span class="op">,</span> <span class="str">'hour_12'</span><span class="op">,</span> <span class="str">'hour_13'</span><span class="op">,</span> <span class="str">'hour_14'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t130" class="pln"><span class="n"><a href="#t130">130</a></span><span class="t">                                   <span class="str">'hour_15'</span><span class="op">,</span> <span class="str">'hour_16'</span><span class="op">,</span> <span class="str">'hour_17'</span><span class="op">,</span> <span class="str">'hour_18'</span><span class="op">,</span> <span class="str">'hour_19'</span><span class="op">,</span> <span class="str">'hour_20'</span><span class="op">,</span> <span class="str">'hour_21'</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t131" class="pln"><span class="n"><a href="#t131">131</a></span><span class="t">                                   <span class="str">'hour_22'</span><span class="op">,</span> <span class="str">'hour_23'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t132" class="pln"><span class="n"><a href="#t132">132</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t133" class="run"><span class="n"><a href="#t133">133</a></span><span class="t">        <span class="key">for</span> <span class="nam">route</span> <span class="key">in</span> <span class="nam">routes</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t134" class="run"><span class="n"><a href="#t134">134</a></span><span class="t">            <span class="key">try</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t135" class="run"><span class="n"><a href="#t135">135</a></span><span class="t">                <span class="nam">timetabledjourneytime</span> <span class="op">=</span> <span class="nam">math</span><span class="op">.</span><span class="nam">log</span><span class="op">(</span><span class="nam">journeytimes</span><span class="op">[</span><span class="nam">route</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t136" class="run"><span class="n"><a href="#t136">136</a></span><span class="t">                <span class="nam">distance</span> <span class="op">=</span> <span class="nam">math</span><span class="op">.</span><span class="nam">log</span><span class="op">(</span><span class="nam">distances</span><span class="op">[</span><span class="nam">route</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t137" class="mis show_mis"><span class="n"><a href="#t137">137</a></span><span class="t">            <span class="key">except</span> <span class="nam">IndexError</span> <span class="key">as</span> <span class="nam">e</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t138" class="mis show_mis"><span class="n"><a href="#t138">138</a></span><span class="t">                <span class="key">raise</span> <span class="nam">PartialRouteNotAvailable</span>&nbsp;</span><span class="r"></span></p>
    <p id="t139" class="pln"><span class="n"><a href="#t139">139</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t140" class="run"><span class="n"><a href="#t140">140</a></span><span class="t">            <span class="nam">features</span> <span class="op">=</span> <span class="op">{</span><span class="str">'Monday'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'Tuesday'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'Wednesday'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'Thursday'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'Friday'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'Saturday'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t141" class="pln"><span class="n"><a href="#t141">141</a></span><span class="t">                        <span class="str">'Sunday'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t142" class="pln"><span class="n"><a href="#t142">142</a></span><span class="t">                        <span class="com"># timetabledtimes</span>&nbsp;</span><span class="r"></span></p>
    <p id="t143" class="pln"><span class="n"><a href="#t143">143</a></span><span class="t">                        <span class="str">'timetabledtimes'</span><span class="op">:</span> <span class="nam">timetabledjourneytime</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t144" class="pln"><span class="n"><a href="#t144">144</a></span><span class="t">                        <span class="com"># distances</span>&nbsp;</span><span class="r"></span></p>
    <p id="t145" class="pln"><span class="n"><a href="#t145">145</a></span><span class="t">                        <span class="str">'distance'</span><span class="op">:</span> <span class="nam">distance</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t146" class="pln"><span class="n"><a href="#t146">146</a></span><span class="t">                        <span class="str">'rain'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'temp'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'rhum'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">'msl'</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t147" class="pln"><span class="n"><a href="#t147">147</a></span><span class="t">                        <span class="com"># holiday</span>&nbsp;</span><span class="r"></span></p>
    <p id="t148" class="pln"><span class="n"><a href="#t148">148</a></span><span class="t">                        <span class="str">'holiday'</span><span class="op">:</span> <span class="nam">holiday</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t149" class="pln"><span class="n"><a href="#t149">149</a></span><span class="t">                        <span class="com"># hour</span>&nbsp;</span><span class="r"></span></p>
    <p id="t150" class="pln"><span class="n"><a href="#t150">150</a></span><span class="t">                        <span class="str">"hour_0"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"hour_1"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"hour_5"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"hour_6"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"hour_7"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span> <span class="str">"hour_8"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t151" class="pln"><span class="n"><a href="#t151">151</a></span><span class="t">                        <span class="str">"hour_9"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t152" class="pln"><span class="n"><a href="#t152">152</a></span><span class="t">                        <span class="str">"hour_10"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t153" class="pln"><span class="n"><a href="#t153">153</a></span><span class="t">                        <span class="str">"hour_11"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t154" class="pln"><span class="n"><a href="#t154">154</a></span><span class="t">                        <span class="str">"hour_12"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t155" class="pln"><span class="n"><a href="#t155">155</a></span><span class="t">                        <span class="str">"hour_13"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t156" class="pln"><span class="n"><a href="#t156">156</a></span><span class="t">                        <span class="str">"hour_14"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t157" class="pln"><span class="n"><a href="#t157">157</a></span><span class="t">                        <span class="str">"hour_15"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t158" class="pln"><span class="n"><a href="#t158">158</a></span><span class="t">                        <span class="str">"hour_16"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t159" class="pln"><span class="n"><a href="#t159">159</a></span><span class="t">                        <span class="str">"hour_17"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t160" class="pln"><span class="n"><a href="#t160">160</a></span><span class="t">                        <span class="str">"hour_18"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t161" class="pln"><span class="n"><a href="#t161">161</a></span><span class="t">                        <span class="str">"hour_19"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t162" class="pln"><span class="n"><a href="#t162">162</a></span><span class="t">                        <span class="str">"hour_20"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t163" class="pln"><span class="n"><a href="#t163">163</a></span><span class="t">                        <span class="str">"hour_21"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t164" class="pln"><span class="n"><a href="#t164">164</a></span><span class="t">                        <span class="str">"hour_22"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t165" class="pln"><span class="n"><a href="#t165">165</a></span><span class="t">                        <span class="str">"hour_23"</span><span class="op">:</span> <span class="num">0</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t166" class="pln"><span class="n"><a href="#t166">166</a></span><span class="t">                        <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p id="t167" class="pln"><span class="n"><a href="#t167">167</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t168" class="run"><span class="n"><a href="#t168">168</a></span><span class="t">            <span class="key">for</span> <span class="nam">day</span> <span class="key">in</span> <span class="nam">days</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t169" class="run"><span class="n"><a href="#t169">169</a></span><span class="t">                <span class="nam">features</span><span class="op">[</span><span class="nam">day</span><span class="op">]</span> <span class="op">=</span> <span class="nam">days</span><span class="op">[</span><span class="nam">day</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t170" class="run"><span class="n"><a href="#t170">170</a></span><span class="t">            <span class="nam">features</span><span class="op">[</span><span class="str">"rain"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rain</span>&nbsp;</span><span class="r"></span></p>
    <p id="t171" class="run"><span class="n"><a href="#t171">171</a></span><span class="t">            <span class="nam">features</span><span class="op">[</span><span class="str">"temp"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">temp</span>&nbsp;</span><span class="r"></span></p>
    <p id="t172" class="run"><span class="n"><a href="#t172">172</a></span><span class="t">            <span class="nam">features</span><span class="op">[</span><span class="str">"rhum"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rhum</span>&nbsp;</span><span class="r"></span></p>
    <p id="t173" class="run"><span class="n"><a href="#t173">173</a></span><span class="t">            <span class="nam">features</span><span class="op">[</span><span class="str">"msl"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">msl</span>&nbsp;</span><span class="r"></span></p>
    <p id="t174" class="run"><span class="n"><a href="#t174">174</a></span><span class="t">            <span class="nam">hour</span> <span class="op">=</span> <span class="nam">departure</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">":"</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t175" class="run"><span class="n"><a href="#t175">175</a></span><span class="t">            <span class="nam">features</span><span class="op">[</span><span class="str">"hour"</span> <span class="op">+</span> <span class="str">"_"</span> <span class="op">+</span> <span class="nam">hour</span><span class="op">[</span><span class="num">1</span><span class="op">:</span><span class="op">]</span> <span class="key">if</span> <span class="nam">hour</span><span class="op">.</span><span class="nam">startswith</span><span class="op">(</span><span class="str">"0"</span><span class="op">)</span> <span class="key">else</span> <span class="str">"hour"</span> <span class="op">+</span> <span class="str">"_"</span> <span class="op">+</span> <span class="nam">hour</span><span class="op">]</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t176" class="run"><span class="n"><a href="#t176">176</a></span><span class="t">            <span class="nam">df</span> <span class="op">=</span> <span class="nam">df</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">features</span><span class="op">,</span> <span class="nam">ignore_index</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t177" class="pln"><span class="n"><a href="#t177">177</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t178" class="run"><span class="n"><a href="#t178">178</a></span><span class="t">        <span class="nam">result</span> <span class="op">=</span> <span class="nam">loadedmodel</span><span class="op">.</span><span class="nam">predict</span><span class="op">(</span><span class="nam">df</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t179" class="run"><span class="n"><a href="#t179">179</a></span><span class="t">        <span class="nam">total_time</span> <span class="op">+=</span> <span class="nam">sum</span><span class="op">(</span><span class="op">[</span><span class="nam">math</span><span class="op">.</span><span class="nam">e</span> <span class="op">**</span> <span class="nam">r</span> <span class="key">for</span> <span class="nam">r</span> <span class="key">in</span> <span class="nam">result</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t180" class="run"><span class="n"><a href="#t180">180</a></span><span class="t">        <span class="nam">time</span> <span class="op">=</span> <span class="nam">timedelta</span><span class="op">(</span><span class="nam">seconds</span><span class="op">=</span><span class="nam">total_time</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t181" class="run"><span class="n"><a href="#t181">181</a></span><span class="t">        <span class="key">return</span> <span class="nam">time</span>&nbsp;</span><span class="r"></span></p>
    <p id="t182" class="pln"><span class="n"><a href="#t182">182</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t183" class="run"><span class="n"><a href="#t183">183</a></span><span class="t">    <span class="key">if</span> <span class="nam">request</span><span class="op">.</span><span class="nam">POST</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'action'</span><span class="op">)</span> <span class="op">==</span> <span class="str">'post'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t184" class="run"><span class="n"><a href="#t184">184</a></span><span class="t">        <span class="nam">print</span><span class="op">(</span><span class="nam">request</span><span class="op">.</span><span class="nam">POST</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t185" class="run"><span class="n"><a href="#t185">185</a></span><span class="t">        <span class="nam">journeys</span> <span class="op">=</span> <span class="nam">request</span><span class="op">.</span><span class="nam">POST</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">'journeys'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t186" class="run"><span class="n"><a href="#t186">186</a></span><span class="t">        <span class="nam">parsed_j</span> <span class="op">=</span> <span class="nam">json</span><span class="op">.</span><span class="nam">loads</span><span class="op">(</span><span class="nam">journeys</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t187" class="run"><span class="n"><a href="#t187">187</a></span><span class="t">        <span class="nam">response</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t188" class="run"><span class="n"><a href="#t188">188</a></span><span class="t">        <span class="nam">total_journey_time</span> <span class="op">=</span> <span class="nam">timedelta</span><span class="op">(</span><span class="nam">seconds</span><span class="op">=</span><span class="num">0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t189" class="run"><span class="n"><a href="#t189">189</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t190" class="run"><span class="n"><a href="#t190">190</a></span><span class="t">            <span class="nam">DayOfService</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'dayofservice'</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="num">1e3</span>&nbsp;</span><span class="r"></span></p>
    <p id="t191" class="run"><span class="n"><a href="#t191">191</a></span><span class="t">            <span class="nam">day</span> <span class="op">=</span> <span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'day'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t192" class="run"><span class="n"><a href="#t192">192</a></span><span class="t">            <span class="nam">LineId</span> <span class="op">=</span> <span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'line'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t193" class="run"><span class="n"><a href="#t193">193</a></span><span class="t">            <span class="nam">olat</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'olat'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t194" class="run"><span class="n"><a href="#t194">194</a></span><span class="t">            <span class="nam">olng</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'olng'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t195" class="run"><span class="n"><a href="#t195">195</a></span><span class="t">            <span class="nam">dlat</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'dlat'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t196" class="run"><span class="n"><a href="#t196">196</a></span><span class="t">            <span class="nam">dlng</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'dlng'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t197" class="run"><span class="n"><a href="#t197">197</a></span><span class="t">            <span class="nam">departure</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">'departure'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t198" class="run"><span class="n"><a href="#t198">198</a></span><span class="t">            <span class="nam">departure</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">fromtimestamp</span><span class="op">(</span><span class="nam">departure</span> <span class="op">/</span> <span class="num">1e3</span><span class="op">)</span><span class="op">.</span><span class="nam">strftime</span><span class="op">(</span><span class="str">"%H:%M:%S"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t199" class="run"><span class="n"><a href="#t199">199</a></span><span class="t">            <span class="key">try</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t200" class="run"><span class="n"><a href="#t200">200</a></span><span class="t">                <span class="nam">journey_time</span> <span class="op">=</span> <span class="op">(</span><span class="nam">route_journey_time</span><span class="op">(</span><span class="nam">DayOfService</span><span class="op">,</span> <span class="nam">day</span><span class="op">,</span> <span class="nam">LineId</span><span class="op">,</span> <span class="nam">olat</span><span class="op">,</span> <span class="nam">olng</span><span class="op">,</span> <span class="nam">dlat</span><span class="op">,</span> <span class="nam">dlng</span><span class="op">,</span> <span class="nam">departure</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t201" class="run"><span class="n"><a href="#t201">201</a></span><span class="t">                <span class="nam">total_journey_time</span> <span class="op">=</span> <span class="nam">total_journey_time</span> <span class="op">+</span> <span class="nam">journey_time</span>&nbsp;</span><span class="r"></span></p>
    <p id="t202" class="run"><span class="n"><a href="#t202">202</a></span><span class="t">                <span class="nam">journey_time</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">journey_time</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t203" class="run"><span class="n"><a href="#t203">203</a></span><span class="t">                <span class="nam">hours</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">journey_time</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">":"</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t204" class="run"><span class="n"><a href="#t204">204</a></span><span class="t">                <span class="nam">mins</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">journey_time</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">":"</span><span class="op">)</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t205" class="run"><span class="n"><a href="#t205">205</a></span><span class="t">                <span class="nam">sec</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">journey_time</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">":"</span><span class="op">)</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t206" class="run"><span class="n"><a href="#t206">206</a></span><span class="t">                <span class="nam">arrival_time</span> <span class="op">=</span> <span class="str">"{:1} Hours {:2} Mins {:.0f} Seconds"</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">hours</span><span class="op">,</span> <span class="nam">mins</span><span class="op">,</span> <span class="nam">sec</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t207" class="run"><span class="n"><a href="#t207">207</a></span><span class="t">                <span class="nam">response</span> <span class="op">+=</span> <span class="str">"&lt;p>&lt;span class='lineid'>{} Bus&lt;/span> : {}&lt;/p>"</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">LineId</span><span class="op">,</span> <span class="nam">arrival_time</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t208" class="run"><span class="n"><a href="#t208">208</a></span><span class="t">            <span class="key">except</span> <span class="nam">RouteNotAvailable</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t209" class="run"><span class="n"><a href="#t209">209</a></span><span class="t">                <span class="nam">response</span> <span class="op">+=</span> <span class="str">"&lt;p>&lt;span class='lineid'>{} Bus&lt;/span> : {}&lt;/p>"</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">LineId</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t210" class="pln"><span class="n"><a href="#t210">210</a></span><span class="t">                                                                                    <span class="str">"Prediction not available for this journey"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t211" class="mis show_mis"><span class="n"><a href="#t211">211</a></span><span class="t">            <span class="key">except</span> <span class="nam">PartialRouteNotAvailable</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t212" class="mis show_mis"><span class="n"><a href="#t212">212</a></span><span class="t">                <span class="nam">response</span> <span class="op">+=</span> <span class="str">"&lt;p>&lt;span class='lineid'>{} Bus&lt;/span> : {}&lt;/p>"</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">LineId</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t213" class="pln"><span class="n"><a href="#t213">213</a></span><span class="t">                                                                                    <span class="str">"Prediction not available for parts of this journey"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t214" class="run"><span class="n"><a href="#t214">214</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">parsed_j</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t215" class="run"><span class="n"><a href="#t215">215</a></span><span class="t">            <span class="nam">journey_time</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">total_journey_time</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t216" class="run"><span class="n"><a href="#t216">216</a></span><span class="t">            <span class="nam">hours</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">journey_time</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">":"</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t217" class="run"><span class="n"><a href="#t217">217</a></span><span class="t">            <span class="nam">mins</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">journey_time</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">":"</span><span class="op">)</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t218" class="run"><span class="n"><a href="#t218">218</a></span><span class="t">            <span class="nam">sec</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">journey_time</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">":"</span><span class="op">)</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t219" class="run"><span class="n"><a href="#t219">219</a></span><span class="t">            <span class="nam">arrival_time</span> <span class="op">=</span> <span class="str">"{:1} Hours {:2} Mins {:.0f} Seconds"</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="nam">hours</span><span class="op">,</span> <span class="nam">mins</span><span class="op">,</span> <span class="nam">sec</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t220" class="run"><span class="n"><a href="#t220">220</a></span><span class="t">            <span class="nam">response</span> <span class="op">+=</span> <span class="str">"&lt;p>&lt;span class='lineid'>{}&lt;/span> : {}&lt;/p>"</span><span class="op">.</span><span class="nam">format</span><span class="op">(</span><span class="str">"Total Time"</span><span class="op">,</span> <span class="nam">arrival_time</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t221" class="run"><span class="n"><a href="#t221">221</a></span><span class="t">        <span class="key">return</span> <span class="nam">JsonResponse</span><span class="op">(</span><span class="op">{</span><span class="str">'result'</span><span class="op">:</span> <span class="nam">response</span><span class="op">}</span><span class="op">,</span> <span class="nam">safe</span><span class="op">=</span><span class="key">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t222" class="pln"><span class="n"><a href="#t222">222</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t223" class="pln"><span class="n"><a href="#t223">223</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t224" class="run"><span class="n"><a href="#t224">224</a></span><span class="t"><span class="key">def</span> <span class="nam">get_route</span><span class="op">(</span><span class="nam">departure</span><span class="op">,</span> <span class="nam">olat</span><span class="op">,</span> <span class="nam">olng</span><span class="op">,</span> <span class="nam">dlat</span><span class="op">,</span> <span class="nam">dlng</span><span class="op">,</span> <span class="nam">day</span><span class="op">,</span> <span class="nam">bus_route</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t225" class="run"><span class="n"><a href="#t225">225</a></span><span class="t">    <span class="nam">day</span> <span class="op">=</span> <span class="nam">day</span><span class="op">.</span><span class="nam">lower</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t226" class="run"><span class="n"><a href="#t226">226</a></span><span class="t">    <span class="nam">bus_route</span> <span class="op">=</span> <span class="nam">bus_route</span><span class="op">.</span><span class="nam">lower</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t227" class="pln"><span class="n"><a href="#t227">227</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t228" class="run"><span class="n"><a href="#t228">228</a></span><span class="t">    <span class="key">def</span> <span class="nam">trips_day</span><span class="op">(</span><span class="nam">day</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t229" class="pln"><span class="n"><a href="#t229">229</a></span><span class="t">        <span class="str">"""Get all trips for that day"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t230" class="run"><span class="n"><a href="#t230">230</a></span><span class="t">        <span class="nam">days</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">calendar</span><span class="op">[</span><span class="nam">calendar</span><span class="op">[</span><span class="nam">day</span><span class="op">]</span> <span class="op">==</span> <span class="num">1</span><span class="op">]</span><span class="op">[</span><span class="str">"service_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t231" class="run"><span class="n"><a href="#t231">231</a></span><span class="t">        <span class="nam">day_trips</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">trips</span><span class="op">[</span><span class="nam">trips</span><span class="op">[</span><span class="str">"service_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">isin</span><span class="op">(</span><span class="nam">days</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t232" class="run"><span class="n"><a href="#t232">232</a></span><span class="t">        <span class="key">return</span> <span class="nam">day_trips</span>&nbsp;</span><span class="r"></span></p>
    <p id="t233" class="pln"><span class="n"><a href="#t233">233</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t234" class="run"><span class="n"><a href="#t234">234</a></span><span class="t">    <span class="key">def</span> <span class="nam">trips_route</span><span class="op">(</span><span class="nam">bus_route</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t235" class="pln"><span class="n"><a href="#t235">235</a></span><span class="t">        <span class="str">"""Get all the trips for that route"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t236" class="run"><span class="n"><a href="#t236">236</a></span><span class="t">        <span class="nam">route_trips</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p id="t237" class="pln"><span class="n"><a href="#t237">237</a></span><span class="t">            <span class="nam">trips</span><span class="op">[</span><span class="nam">trips</span><span class="op">[</span><span class="str">"route_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">isin</span><span class="op">(</span><span class="nam">list</span><span class="op">(</span><span class="nam">routes</span><span class="op">[</span><span class="nam">routes</span><span class="op">[</span><span class="str">"route_short_name"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">bus_route</span><span class="op">]</span><span class="op">[</span><span class="str">"route_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t238" class="pln"><span class="n"><a href="#t238">238</a></span><span class="t">                <span class="str">"trip_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t239" class="run"><span class="n"><a href="#t239">239</a></span><span class="t">        <span class="key">return</span> <span class="nam">route_trips</span>&nbsp;</span><span class="r"></span></p>
    <p id="t240" class="pln"><span class="n"><a href="#t240">240</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t241" class="run"><span class="n"><a href="#t241">241</a></span><span class="t">    <span class="key">def</span> <span class="nam">best_stop</span><span class="op">(</span><span class="nam">trips</span><span class="op">,</span> <span class="nam">lat</span><span class="op">,</span> <span class="nam">lon</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t242" class="pln"><span class="n"><a href="#t242">242</a></span><span class="t">        <span class="str">"""Get the best corresponding stop for a list of trips"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t243" class="run"><span class="n"><a href="#t243">243</a></span><span class="t">        <span class="nam">possible_stop_ids</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">isin</span><span class="op">(</span><span class="nam">list</span><span class="op">(</span><span class="nam">trips</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">drop_duplicates</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t244" class="run"><span class="n"><a href="#t244">244</a></span><span class="t">        <span class="nam">test</span> <span class="op">=</span> <span class="nam">stops</span><span class="op">[</span><span class="nam">stops</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">isin</span><span class="op">(</span><span class="nam">possible_stop_ids</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="op">[</span><span class="str">"stop_name"</span><span class="op">,</span> <span class="str">"stop_id"</span><span class="op">,</span> <span class="str">"stop_lat"</span><span class="op">,</span> <span class="str">"stop_lon"</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t245" class="run"><span class="n"><a href="#t245">245</a></span><span class="t">        <span class="nam">test</span><span class="op">[</span><span class="str">"lat"</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="nam">lat</span><span class="op">]</span> <span class="op">*</span> <span class="nam">len</span><span class="op">(</span><span class="nam">test</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t246" class="run"><span class="n"><a href="#t246">246</a></span><span class="t">        <span class="nam">test</span><span class="op">[</span><span class="str">"lon"</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="nam">lon</span><span class="op">]</span> <span class="op">*</span> <span class="nam">len</span><span class="op">(</span><span class="nam">test</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t247" class="run"><span class="n"><a href="#t247">247</a></span><span class="t">        <span class="nam">distances</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t248" class="run"><span class="n"><a href="#t248">248</a></span><span class="t">        <span class="key">for</span> <span class="nam">index</span><span class="op">,</span> <span class="nam">row</span> <span class="key">in</span> <span class="nam">test</span><span class="op">.</span><span class="nam">iterrows</span><span class="op">(</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t249" class="run"><span class="n"><a href="#t249">249</a></span><span class="t">            <span class="nam">distance</span> <span class="op">=</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">d</span><span class="op">(</span><span class="op">(</span><span class="nam">row</span><span class="op">[</span><span class="str">"stop_lat"</span><span class="op">]</span><span class="op">,</span> <span class="nam">row</span><span class="op">[</span><span class="str">"stop_lon"</span><span class="op">]</span><span class="op">)</span><span class="op">,</span> <span class="op">(</span><span class="nam">row</span><span class="op">[</span><span class="str">"lat"</span><span class="op">]</span><span class="op">,</span> <span class="nam">row</span><span class="op">[</span><span class="str">"lon"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">km</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t250" class="run"><span class="n"><a href="#t250">250</a></span><span class="t">            <span class="nam">distances</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">distance</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t251" class="run"><span class="n"><a href="#t251">251</a></span><span class="t">        <span class="nam">test</span><span class="op">[</span><span class="str">"distances"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">distances</span>&nbsp;</span><span class="r"></span></p>
    <p id="t252" class="run"><span class="n"><a href="#t252">252</a></span><span class="t">        <span class="nam">test</span> <span class="op">=</span> <span class="nam">test</span><span class="op">.</span><span class="nam">sort_values</span><span class="op">(</span><span class="nam">by</span><span class="op">=</span><span class="str">"distances"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t253" class="pln"><span class="n"><a href="#t253">253</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t254" class="run"><span class="n"><a href="#t254">254</a></span><span class="t">        <span class="key">return</span> <span class="nam">test</span><span class="op">[</span><span class="op">:</span><span class="num">1</span><span class="op">]</span><span class="op">[</span><span class="str">"stop_name"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span> <span class="nam">test</span><span class="op">[</span><span class="op">:</span><span class="num">1</span><span class="op">]</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t255" class="pln"><span class="n"><a href="#t255">255</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t256" class="run"><span class="n"><a href="#t256">256</a></span><span class="t">    <span class="key">def</span> <span class="nam">trips_with_origin_destination_day_route</span><span class="op">(</span><span class="nam">trips</span><span class="op">,</span> <span class="nam">o_id</span><span class="op">,</span> <span class="nam">d_id</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t257" class="run"><span class="n"><a href="#t257">257</a></span><span class="t">        <span class="nam">start</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">o_id</span><span class="op">]</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t258" class="run"><span class="n"><a href="#t258">258</a></span><span class="t">        <span class="nam">end</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">d_id</span><span class="op">]</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t259" class="run"><span class="n"><a href="#t259">259</a></span><span class="t">        <span class="nam">trips</span> <span class="op">=</span> <span class="nam">start</span><span class="op">.</span><span class="nam">intersection</span><span class="op">(</span><span class="nam">end</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t260" class="run"><span class="n"><a href="#t260">260</a></span><span class="t">        <span class="nam">trips</span> <span class="op">=</span> <span class="nam">trips</span><span class="op">.</span><span class="nam">intersection</span><span class="op">(</span><span class="nam">trips</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t261" class="run"><span class="n"><a href="#t261">261</a></span><span class="t">        <span class="key">return</span> <span class="nam">trips</span>&nbsp;</span><span class="r"></span></p>
    <p id="t262" class="pln"><span class="n"><a href="#t262">262</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t263" class="run"><span class="n"><a href="#t263">263</a></span><span class="t">    <span class="key">def</span> <span class="nam">trips_correct_dir</span><span class="op">(</span><span class="nam">trips</span><span class="op">,</span> <span class="nam">o_id</span><span class="op">,</span> <span class="nam">d_id</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t264" class="run"><span class="n"><a href="#t264">264</a></span><span class="t">        <span class="nam">I</span><span class="op">,</span> <span class="nam">O</span> <span class="op">=</span> <span class="key">None</span><span class="op">,</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p id="t265" class="run"><span class="n"><a href="#t265">265</a></span><span class="t">        <span class="key">for</span> <span class="nam">trip</span> <span class="key">in</span> <span class="nam">r</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t266" class="run"><span class="n"><a href="#t266">266</a></span><span class="t">            <span class="key">if</span> <span class="nam">re</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="str">".I$"</span><span class="op">,</span> <span class="nam">trip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t267" class="run"><span class="n"><a href="#t267">267</a></span><span class="t">                <span class="nam">I</span> <span class="op">=</span> <span class="nam">trip</span>&nbsp;</span><span class="r"></span></p>
    <p id="t268" class="run"><span class="n"><a href="#t268">268</a></span><span class="t">                <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p id="t269" class="run"><span class="n"><a href="#t269">269</a></span><span class="t">        <span class="key">for</span> <span class="nam">trip</span> <span class="key">in</span> <span class="nam">r</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t270" class="run"><span class="n"><a href="#t270">270</a></span><span class="t">            <span class="key">if</span> <span class="nam">re</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="str">".O$"</span><span class="op">,</span> <span class="nam">trip</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t271" class="run"><span class="n"><a href="#t271">271</a></span><span class="t">                <span class="nam">O</span> <span class="op">=</span> <span class="nam">trip</span>&nbsp;</span><span class="r"></span></p>
    <p id="t272" class="run"><span class="n"><a href="#t272">272</a></span><span class="t">                <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p id="t273" class="pln"><span class="n"><a href="#t273">273</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t274" class="run"><span class="n"><a href="#t274">274</a></span><span class="t">        <span class="nam">correct_direction</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t275" class="run"><span class="n"><a href="#t275">275</a></span><span class="t">        <span class="key">if</span> <span class="nam">O</span> <span class="op">!=</span> <span class="key">None</span> <span class="key">and</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p id="t276" class="pln"><span class="n"><a href="#t276">276</a></span><span class="t">                <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">O</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">o_id</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">"stop_sequence"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t277" class="pln"><span class="n"><a href="#t277">277</a></span><span class="t">                    <span class="num">0</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">O</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">d_id</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t278" class="pln"><span class="n"><a href="#t278">278</a></span><span class="t">            <span class="str">"stop_sequence"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t279" class="run"><span class="n"><a href="#t279">279</a></span><span class="t">            <span class="nam">correct_direction</span> <span class="op">=</span> <span class="op">[</span><span class="nam">trip</span> <span class="key">for</span> <span class="nam">trip</span> <span class="key">in</span> <span class="nam">r</span> <span class="key">if</span> <span class="nam">re</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="str">".O$"</span><span class="op">,</span> <span class="nam">trip</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t280" class="run"><span class="n"><a href="#t280">280</a></span><span class="t">        <span class="key">elif</span> <span class="nam">I</span> <span class="op">!=</span> <span class="key">None</span> <span class="key">and</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p id="t281" class="pln"><span class="n"><a href="#t281">281</a></span><span class="t">                <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">I</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">o_id</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="str">"stop_sequence"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t282" class="pln"><span class="n"><a href="#t282">282</a></span><span class="t">                    <span class="num">0</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">I</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">d_id</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t283" class="pln"><span class="n"><a href="#t283">283</a></span><span class="t">            <span class="str">"stop_sequence"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t284" class="run"><span class="n"><a href="#t284">284</a></span><span class="t">            <span class="nam">correct_direction</span> <span class="op">=</span> <span class="op">[</span><span class="nam">trip</span> <span class="key">for</span> <span class="nam">trip</span> <span class="key">in</span> <span class="nam">r</span> <span class="key">if</span> <span class="nam">re</span><span class="op">.</span><span class="nam">search</span><span class="op">(</span><span class="str">".I$"</span><span class="op">,</span> <span class="nam">trip</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t285" class="run"><span class="n"><a href="#t285">285</a></span><span class="t">        <span class="key">return</span> <span class="nam">set</span><span class="op">(</span><span class="nam">correct_direction</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t286" class="pln"><span class="n"><a href="#t286">286</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t287" class="run"><span class="n"><a href="#t287">287</a></span><span class="t">    <span class="key">def</span> <span class="nam">best_trip_for_time</span><span class="op">(</span><span class="nam">r</span><span class="op">,</span> <span class="nam">departure</span><span class="op">,</span> <span class="nam">stop_id</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t288" class="run"><span class="n"><a href="#t288">288</a></span><span class="t">        <span class="nam">final</span> <span class="op">=</span> <span class="nam">stop_times</span><span class="op">[</span><span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span><span class="op">.</span><span class="nam">isin</span><span class="op">(</span><span class="nam">r</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">stop_id</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p id="t289" class="pln"><span class="n"><a href="#t289">289</a></span><span class="t">            <span class="op">[</span><span class="str">"trip_id"</span><span class="op">,</span> <span class="str">"arrival_time"</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t290" class="run"><span class="n"><a href="#t290">290</a></span><span class="t">        <span class="nam">final</span><span class="op">[</span><span class="str">"arrival_time"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">abs</span><span class="op">(</span><span class="nam">final</span><span class="op">[</span><span class="str">"arrival_time"</span><span class="op">]</span> <span class="op">-</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">to_timedelta</span><span class="op">(</span><span class="nam">departure</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t291" class="run"><span class="n"><a href="#t291">291</a></span><span class="t">        <span class="nam">final</span> <span class="op">=</span> <span class="nam">final</span><span class="op">.</span><span class="nam">sort_values</span><span class="op">(</span><span class="nam">by</span><span class="op">=</span><span class="str">"arrival_time"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t292" class="run"><span class="n"><a href="#t292">292</a></span><span class="t">        <span class="nam">tripid</span> <span class="op">=</span> <span class="nam">final</span><span class="op">.</span><span class="nam">iloc</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t293" class="run"><span class="n"><a href="#t293">293</a></span><span class="t">        <span class="key">return</span> <span class="nam">tripid</span>&nbsp;</span><span class="r"></span></p>
    <p id="t294" class="pln"><span class="n"><a href="#t294">294</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t295" class="run"><span class="n"><a href="#t295">295</a></span><span class="t">    <span class="key">def</span> <span class="nam">station_to_station</span><span class="op">(</span><span class="nam">tripid</span><span class="op">,</span> <span class="nam">o_id</span><span class="op">,</span> <span class="nam">d_id</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t296" class="run"><span class="n"><a href="#t296">296</a></span><span class="t">        <span class="nam">seq</span> <span class="op">=</span> <span class="nam">stop_times</span><span class="op">[</span><span class="nam">stop_times</span><span class="op">[</span><span class="str">"trip_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">tripid</span><span class="op">]</span><span class="op">[</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">,</span> <span class="str">"stop_sequence"</span><span class="op">]</span><span class="op">]</span><span class="op">.</span><span class="nam">sort_values</span><span class="op">(</span><span class="nam">by</span><span class="op">=</span><span class="str">"stop_sequence"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t297" class="run"><span class="n"><a href="#t297">297</a></span><span class="t">        <span class="nam">rstart</span> <span class="op">=</span> <span class="nam">seq</span><span class="op">[</span><span class="nam">seq</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">o_id</span><span class="op">]</span><span class="op">.</span><span class="nam">index</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t298" class="run"><span class="n"><a href="#t298">298</a></span><span class="t">        <span class="nam">rfin</span> <span class="op">=</span> <span class="nam">seq</span><span class="op">[</span><span class="nam">seq</span><span class="op">[</span><span class="str">"stop_id"</span><span class="op">]</span> <span class="op">==</span> <span class="nam">d_id</span><span class="op">]</span><span class="op">.</span><span class="nam">index</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t299" class="run"><span class="n"><a href="#t299">299</a></span><span class="t">        <span class="nam">test</span> <span class="op">=</span> <span class="nam">seq</span><span class="op">.</span><span class="nam">loc</span><span class="op">[</span><span class="nam">rstart</span><span class="op">:</span><span class="nam">rfin</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t300" class="run"><span class="n"><a href="#t300">300</a></span><span class="t">        <span class="nam">final</span> <span class="op">=</span> <span class="nam">test</span><span class="op">.</span><span class="nam">merge</span><span class="op">(</span><span class="nam">stops</span><span class="op">,</span> <span class="nam">how</span><span class="op">=</span><span class="str">'left'</span><span class="op">,</span> <span class="nam">on</span><span class="op">=</span><span class="str">'stop_id'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t301" class="run"><span class="n"><a href="#t301">301</a></span><span class="t">        <span class="nam">flist</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">final</span><span class="op">[</span><span class="str">"stop_name"</span><span class="op">]</span><span class="op">.</span><span class="nam">values</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t302" class="run"><span class="n"><a href="#t302">302</a></span><span class="t">        <span class="nam">flist</span> <span class="op">=</span> <span class="op">[</span><span class="nam">stop</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">" stop "</span><span class="op">)</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">for</span> <span class="nam">stop</span> <span class="key">in</span> <span class="nam">flist</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t303" class="run"><span class="n"><a href="#t303">303</a></span><span class="t">        <span class="nam">final_routes</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t304" class="run"><span class="n"><a href="#t304">304</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">flist</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t305" class="run"><span class="n"><a href="#t305">305</a></span><span class="t">            <span class="nam">final_routes</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">flist</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span> <span class="op">+</span> <span class="str">"_"</span> <span class="op">+</span> <span class="nam">flist</span><span class="op">[</span><span class="nam">i</span> <span class="op">+</span> <span class="num">1</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t306" class="run"><span class="n"><a href="#t306">306</a></span><span class="t">        <span class="nam">final_routes</span>&nbsp;</span><span class="r"></span></p>
    <p id="t307" class="run"><span class="n"><a href="#t307">307</a></span><span class="t">        <span class="key">return</span> <span class="nam">final_routes</span>&nbsp;</span><span class="r"></span></p>
    <p id="t308" class="pln"><span class="n"><a href="#t308">308</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t309" class="run"><span class="n"><a href="#t309">309</a></span><span class="t">    <span class="nam">r</span> <span class="op">=</span> <span class="nam">trips_day</span><span class="op">(</span><span class="nam">day</span><span class="op">)</span><span class="op">.</span><span class="nam">intersection</span><span class="op">(</span><span class="nam">trips_route</span><span class="op">(</span><span class="nam">bus_route</span><span class="op">)</span><span class="op">)</span>  <span class="com"># get intersection of trips for that route and day</span>&nbsp;</span><span class="r"></span></p>
    <p id="t310" class="run"><span class="n"><a href="#t310">310</a></span><span class="t">    <span class="nam">o_name</span><span class="op">,</span> <span class="nam">o_id</span> <span class="op">=</span> <span class="nam">best_stop</span><span class="op">(</span><span class="nam">r</span><span class="op">,</span> <span class="nam">olat</span><span class="op">,</span> <span class="nam">olng</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t311" class="run"><span class="n"><a href="#t311">311</a></span><span class="t">    <span class="nam">d_name</span><span class="op">,</span> <span class="nam">d_id</span> <span class="op">=</span> <span class="nam">best_stop</span><span class="op">(</span><span class="nam">r</span><span class="op">,</span> <span class="nam">dlat</span><span class="op">,</span> <span class="nam">dlng</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t312" class="run"><span class="n"><a href="#t312">312</a></span><span class="t">    <span class="nam">r</span> <span class="op">=</span> <span class="nam">trips_with_origin_destination_day_route</span><span class="op">(</span><span class="nam">r</span><span class="op">,</span> <span class="nam">o_id</span><span class="op">,</span> <span class="nam">d_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t313" class="run"><span class="n"><a href="#t313">313</a></span><span class="t">    <span class="nam">r</span> <span class="op">=</span> <span class="nam">trips_correct_dir</span><span class="op">(</span><span class="nam">r</span><span class="op">,</span> <span class="nam">o_id</span><span class="op">,</span> <span class="nam">d_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t314" class="run"><span class="n"><a href="#t314">314</a></span><span class="t">    <span class="nam">tripid</span> <span class="op">=</span> <span class="nam">best_trip_for_time</span><span class="op">(</span><span class="nam">r</span><span class="op">,</span> <span class="nam">departure</span><span class="op">,</span> <span class="nam">o_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t315" class="run"><span class="n"><a href="#t315">315</a></span><span class="t">    <span class="nam">station_route</span> <span class="op">=</span> <span class="nam">station_to_station</span><span class="op">(</span><span class="nam">tripid</span><span class="op">,</span> <span class="nam">o_id</span><span class="op">,</span> <span class="nam">d_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t316" class="run"><span class="n"><a href="#t316">316</a></span><span class="t">    <span class="key">return</span> <span class="nam">station_route</span>&nbsp;</span><span class="r"></span></p>
    <p id="t317" class="pln"><span class="n"><a href="#t317">317</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t318" class="pln"><span class="n"><a href="#t318">318</a></span><span class="t"><span class="com"># def explore_vue(request):</span>&nbsp;</span><span class="r"></span></p>
    <p id="t319" class="pln"><span class="n"><a href="#t319">319</a></span><span class="t"><span class="com">#     return render(request, 'doubledecker/explore_vue.html')</span>&nbsp;</span><span class="r"></span></p>
</div>
<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v5.5</a>,
            created at 2021-08-09 15:26 +0100
        </p>
    </div>
</div>
</body>
</html>
